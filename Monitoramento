
'Variáveis globais
Public strHTMLTabela As String
Public IdAutomacao As Integer
Public InicioDoProcessamento  'Variável para mensurar o tempo de processamento
Public DataInicioDoProcessamento 'Variável para mensurar o tempo de processamento
Public NomeDoCliente As String
Public Peridiocidade As String
Public NomeDaAutomacao As String
Public Declare PtrSafe Sub Sleep Lib "kernel32" (ByVal dwMilliseconds As LongPtr) ' Método de tempo de espera Sleep



Public Function RotinaPrincipal()

'Declara variáveis locais
Dim rstTabela As DAO.Recordset



'_____________________________ DADOS DE PROCESSAMENTO _____________________________
PDtec_Monitoramento_Automacoes.Rotina.InicioDoProcessamento = Timer
PDtec_Monitoramento_Automacoes.Rotina.DataInicioDoProcessamento = Now
PDtec_Monitoramento_Automacoes.Rotina.NomeDoCliente = "PDTec"
PDtec_Monitoramento_Automacoes.Rotina.NomeDaAutomacao = "PDtec_Monitoramento_Automacoes"
PDtec_Monitoramento_Automacoes.Rotina.Peridiocidade = "Diaria"



'Ativa (True) ou Desativa (False) avisos padrão do Access
DoCmd.SetWarnings False



'Tratamento de erro
On Error GoTo TratarErro



'_____________________________ PRÉ-ROTINA PRINCIPAL _____________________________
'Executa a consulta SQL para atualizar seus dados | Observação: Ao abrir a consulta seus dados são atualizados automaticamente
DoCmd.OpenQuery "001_CONSULTA", acViewNormal, acReadOnly

PDtec_Monitoramento_Automacoes.Rotina.Sleep (20000) '_____ Aguarda 20 segundos antes de continuar

'Fecha a consulta salvando e atualizando
DoCmd.Close acQuery, "001_CONSULTA", acSaveYes



'__________________________ ROTINA PRINCIPAL __________________________
'Atribui a variável o resultado da consulta criada
Set rstTabela = CurrentDb.OpenRecordset("001_CONSULTA")

'Cria a tabela que vai no corpo do e-mail
If Not rstTabela.EOF Then

    'Inicializa a string HTML com a tag da tabela
    PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela = "<table border='1' bordercolor=black>" & vbNewLine

    'Abre a primeira linha para o cabeçalho (TAG tr)
    PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela = PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela & "<tr border='1' bordercolor=black>" & vbNewLine

    'Itera sobre os campos da consulta para criar o cabeçalho da tabela
    For Each Campo In rstTabela.Fields
        PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela = PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela & "<th style='color: white; background-color: rgb(88, 89, 81);' border='1' bordercolor='black'><center>" & Campo.Name & "</center></th>" & vbNewLine
    Next Campo

    'Fecha a linha do cabeçalho
    PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela = PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela & "</tr>" & vbNewLine

    'Itera sobre os registros da consulta para criar as linhas da tabela
    Do While Not rstTabela.EOF
        'Abre uma nova linha para cada registro (TAG tr)
        PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela = PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela & "<tr border='1' bordercolor=black>" & vbNewLine

        'Itera sobre os campos do registro para criar as células
        For Each Campo In rstTabela.Fields
        
            'Atribui a variável o dado
            ValorCelula = Campo.Value
            
            'Se o valor do campo é tipo double ou integer (Numérico) entra na condição para editar o tipo de dado
            PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela = PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela & "<td border='1' bordercolor=black><center>" & "" & ValorCelula & "</center></td>" & vbNewLine
            
        Next Campo

        'Fecha a linha do registro
        PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela = PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela & "</tr>" & vbNewLine

        'Vai para o próximo registro
        rstTabela.MoveNext
        
    Loop

    'Fecha a tabela HTML
    PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela = PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela & "</table>" & vbNewLine

End If



'_____________________________  ENCERRA CONEXÃO _____________________________
rstTabela.Close

    
    
'__________________________ ENVIO DO EMAIL __________________________
'Envia o e-mail de acordo com os parâmetros informados
Call PDtec_Monitoramento_Automacoes.Rotina.EnviaEmail("¡ALERTA! | Automações não executadas | ", "")



'Ativa (True) ou Desativa (False) avisos padrão do Access
DoCmd.SetWarnings True



'_____________________________  ENCERRA O ACCESS _____________________________
DoCmd.Quit



'_____________________________  TRATAMENTO E REGISTRO DE ERRO _____________________________
TratarErro:
    Debug.Print Err.Number
    Debug.Print Err.Description
    If Err.Number > 0 Then
        Call Mdl_Emails.EnviaEmailErro("erro.automacao@pd.tec.br", "tiago.goulart@pd.tec.br", NomeDoCliente, NomeDaAutomacao, Peridiocidade, Err.Number, Err.Description, DataInicioDoProcessamento)
    End If

End Function



Public Sub EnviaEmail(AssuntoEmail As Variant, Optional EmailsEmCopia = "", Optional Anexo = "", Optional EmailsEmCopiaOculta = "")
'_____ Envia um e-mail com base nos parâmetros passados

'Declaração das variáveis
Dim ConfiguracaoServidor
Dim ConfiguracaoMensagem

'Atribui a variável os atributos de um objeto que permite configurar uma conexão com servidor
Set ConfiguracaoServidor = CreateObject("CDO.Configuration")
'Atribui a variável os atributos de um objeto que permite enviar um envio de e-mail
Set ConfiguracaoMensagem = CreateObject("CDO.Message")
'Atribui a variável o link do servidor web da microsoft
schema = "http://schemas.microsoft.com/cdo/configuration/"


'Atribui as variáveis os e-mails correspondentes | Todos os e-mails estão em um arquivo na pasta E:\PDTec_Automacoes_Monitoramento
EmailRemetente = Mdl_Emails.RetornaEmails("BASE_EMAILS", "EMAIL", "AUTOMACAO", Rotina.NomeDaAutomacao, "FROM")
EmailsDestinatarios = Mdl_Emails.RetornaEmails("BASE_EMAILS", "EMAIL", "AUTOMACAO", Rotina.NomeDaAutomacao, "TO")
EmailsEmCopia = Mdl_Emails.RetornaEmails("BASE_EMAILS", "EMAIL", "AUTOMACAO", Rotina.NomeDaAutomacao, "CO")
EmailsEmCopiaOculta = Mdl_Emails.RetornaEmails("BASE_EMAILS", "EMAIL", "AUTOMACAO", Rotina.NomeDaAutomacao, "BCC")

'EmailsDestinatarios = "tiago.goulart@pd.tec.br"
'EmailsEmCopia = "tiago.goulart@pd.tec.br"
'EmailsEmCopiaOculta = "tiago.goulart@pd.tec.br"


'Configura a conexão com servidor para permitir o envio de e-mail através da porta 587
With ConfiguracaoServidor.Fields
    .Item(schema & "sendusing") = 2 'Configuramos o tipo de cliente. 2 indica uso do Outlook
    .Item(schema & "smtpserver") = "email-smtp.sa-east-1.amazonaws.com"
    .Item(schema & "smtpserverport") = 25 'Número da porta
    .Item(schema & "smtpusessl") = True 'Desabilita ou Habilita mensagem segura ou simples
    .Item(schema & "smtpauthenticate") = 1 ' 1 Ativa e 0 desativa a configuração para autenticação
    .Item(schema & "sendusername") = "AKIA5LJIINH7JMPUPQYP" 'E-mail ou usuário
    .Item(schema & "sendpassword") = "BDEjqgWtpYbBrJtWIwj5Ej23ySbz4h36d6WjgdW9UCG3" 'Senha do e-mail ou usuário
    .Item(schema & "charset") = "UTF-8"
    .Update
End With

'Configuração do e-mail
With ConfiguracaoMensagem
    .BodyPart.Charset = "utf-8" 'aplica a codificação dos caracteres PT-BR
    .From = EmailRemetente 'Quem envia a mensagem
    .To = EmailsDestinatarios 'Quem vai receber a mensagem
    If IsEmpty(EmailsEmCopia) = False And EmailsEmCopia <> "" Then .CC = EmailsEmCopia
    If IsEmpty(EmailsEmCopiaOculta) = False And EmailsEmCopiaOculta <> "" Then .BCC = EmailsEmCopiaOculta 'Copia oculta
    If IsEmpty(Anexo) = False And Anexo <> "" Then .AddAttachment (Anexo) 'Caminho do arquivo + nome do arquivo que será anexado
    .Fields.Item("urn:schemas:mailheader:X-MSMail-Priority") = "High"
    .Subject = "" & AssuntoEmail & "" & Now
    'Corpo do e-mail | Mensagem está sendo formatada como HTML
    .HTMLBody = "Olá, tudo bem?<br><br>" & _
                "As automações abaixo não foram executadas hoje dentro do período obrigatório.<br><br>" & _
                    "" & PDtec_Monitoramento_Automacoes.Rotina.strHTMLTabela & "" & _
                "<br><br>" & _
                "Primeiro verifique seus e-mails com alerta de erro." & _
                "<br>" & _
                "Caso não tenham erros, execute novamente a automação." & _
                "<br><br>" & _
                "À disposição.<br>" & _
                "<b>INFORMAÇÃO CONFIDENCIAL</b><br>" & _
                "<b>PDTEC</b> | <i>E-mail encaminhado automaticamente</i>"
    Set .Configuration = ConfiguracaoServidor 'Atribui a propriedade de configuração da porta as configurações do servidor atribuidas a variável
    .send 'Send faz o envio do e-mail
End With

'Limpa as variáveis
Set ConfiguracaoMensagem = Nothing
Set ConfiguracaoServidor = Nothing
 
End Sub
